---
import { getCollection } from 'astro:content';
import { processObsidianLink } from '../../utils/content-processor';
import Heading from '../ui/Heading.astro';
import ReferencesCarouselComponent from './ReferencesCarouselComponent.tsx';

// Get all references, companies, and clients from the local content folders
const references = await getCollection('references');
const companies = await getCollection('companies');
const clients = await getCollection('clients');

// Sort references by portfolioOrder, then alphabetically by name
const sortedReferences = references.sort((a, b) => {
	// First sort by portfolioOrder (lower numbers first)
	const orderA = a.data.portfolioOrder ?? Number.MAX_SAFE_INTEGER;
	const orderB = b.data.portfolioOrder ?? Number.MAX_SAFE_INTEGER;

	if (orderA !== orderB) {
		return orderA - orderB;
	}

	// If portfolioOrder is the same or not set, sort alphabetically by slug
	return a.slug.localeCompare(b.slug);
});

// Process references to include company/client logos
const processedReferences = sortedReferences.map(reference => {
	let companyLogoURL = null;

	// If reference has linkedCompany, find the company or client and get its logoURL
	if (reference.data.linkedCompany && reference.data.linkedCompany.length > 0) {
		// Get the first linked company and process Obsidian link format
		const linkedCompanyRaw = reference.data.linkedCompany[0];
		const linkedCompanyName = processObsidianLink(linkedCompanyRaw);

		// First try to find in companies collection
		const company = companies.find(company => {
			const companyName = company.id.replace('.md', ''); // Remove .md extension
			return companyName === linkedCompanyName;
		});

		if (company && company.data.logoURL) {
			companyLogoURL = company.data.logoURL;
		} else {
			// If not found in companies, try clients collection
			const client = clients.find(client => {
				const clientName = client.id.replace('.md', ''); // Remove .md extension
				return clientName === linkedCompanyName;
			});

			if (client && client.data.logoURL) {
				companyLogoURL = client.data.logoURL;
			}
		}
	}

	return {
		...reference,
		companyLogoURL,
	};
});
---

<section class="py-8 px-8 max-md:py-4 mb-4 scroll-m-16" id="references">
	<div class="flex flex-col pt-8 max-w-6xl mx-auto">
		<div class="flex gap-4 items-center justify-center">
			<svg
				class="text-3xl dark:text-white text-blacktext"
				fill="currentColor"
				viewBox="0 0 15 15"
				xmlns="http://www.w3.org/2000/svg">
				<path
					d="M7.5 0.875C5.49797 0.875 3.875 2.49797 3.875 4.5C3.875 6.15288 4.98124 7.54738 6.49373 7.98351C5.2997 8.12902 4.275 9.10564 4.275 10.3C4.275 10.5629 4.48211 10.775 4.745 10.775H10.255C10.5179 10.775 10.725 10.5629 10.725 10.3C10.725 9.10564 9.7003 8.12902 8.50627 7.98351C10.0188 7.54738 11.125 6.15288 11.125 4.5C11.125 2.49797 9.50203 0.875 7.5 0.875ZM7.5 1.625C9.0864 1.625 10.375 2.9136 10.375 4.5C10.375 6.0864 9.0864 7.375 7.5 7.375C5.9136 7.375 4.625 6.0864 4.625 4.5C4.625 2.9136 5.9136 1.625 7.5 1.625ZM4.625 9.3C4.625 8.61824 5.18024 8.0625 5.8625 8.0625H9.1375C9.81976 8.0625 10.375 8.61824 10.375 9.3V9.95C10.375 10.2324 10.1574 10.45 9.875 10.45H5.125C4.84264 10.45 4.625 10.2324 4.625 9.95V9.3ZM5.8625 8.8125C5.50777 8.8125 5.225 9.09527 5.225 9.45V9.9C5.225 9.95862 5.27338 10.007 5.332 10.007H9.668C9.72662 10.007 9.775 9.95862 9.775 9.9V9.45C9.775 9.09527 9.49223 8.8125 9.1375 8.8125H5.8625Z"
				></path>
			</svg>
			<Heading text="" textGradient="References" level={2} />
		</div>

		<div class="relative max-md:mt-0 mt-8" aria-label="References">
			<ReferencesCarouselComponent
				references={processedReferences.map(ref => ({
					id: ref.id,
					name: ref.data.name || ref.id.replace('.md', ''),
					title: ref.data.referenceRole || '',
					email: ref.data.referenceEmail || '',
					phone: ref.data.referenceNumber || '',
					company: ref.data.linkedCompany
						? processObsidianLink(ref.data.linkedCompany[0])
						: '',
					logoURL: ref.companyLogoURL,
					address: ref.data.referenceAddress || '',
				}))}
				client:only="preact"
			/>
		</div>
	</div>
</section>
