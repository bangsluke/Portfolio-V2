---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';

// Get all companies from the local content folder
const companies = await getCollection('companies');

// Sort companies by creation date (newest first) and filter for portfolio tag
const sortedCompanies = companies
  .filter(company => {
    // Filter out companies that don't have portfolio tag
    return company.data.tags && company.data.tags.includes('portfolio');
  })
  .sort((a, b) => {
    // Sort by creation date, fallback to modification date, then alphabetically
    const dateA = a.data.created || a.data.modified || new Date(0);
    const dateB = b.data.created || b.data.modified || new Date(0);
    
    if (dateA instanceof Date && dateB instanceof Date) {
      return dateB.getTime() - dateA.getTime();
    }
    
    // Fallback to alphabetical sorting by slug
    return a.slug.localeCompare(b.slug);
  });

// Enhanced debug logging
console.log('=== DEBUG CAROUSEL PAGE ===');
console.log('Total companies found:', companies.length);
console.log('Companies with portfolio tag:', sortedCompanies.length);
console.log('All company slugs:', companies.map(c => c.slug));
console.log('Filtered company slugs:', sortedCompanies.map(c => c.slug));
console.log('First company data:', sortedCompanies[0]);
console.log('Companies JSON length:', JSON.stringify(sortedCompanies).length);
console.log('=== END DEBUG ===');
---

<Layout title="Carousel Debug">
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <h1 class="text-3xl font-bold mb-8">Carousel Debug Page</h1>
    
    <!-- Server-side debug info -->
    <div class="bg-blue-100 p-4 rounded-lg mb-8">
      <h2 class="text-xl font-bold mb-4">Server-side Debug Info (Astro Component)</h2>
      <div class="font-mono text-sm">
        <p><strong>Total companies found:</strong> {companies.length}</p>
        <p><strong>Companies with portfolio tag:</strong> {sortedCompanies.length}</p>
        <p><strong>All company slugs:</strong> {companies.map(c => c.slug).join(', ')}</p>
        <p><strong>Filtered company slugs:</strong> {sortedCompanies.map(c => c.slug).join(', ')}</p>
        <p><strong>First company:</strong> {sortedCompanies[0]?.slug || 'none'}</p>
        <p><strong>JSON length:</strong> {JSON.stringify(sortedCompanies).length}</p>
      </div>
    </div>

    <!-- Company details -->
    <div class="bg-green-100 p-4 rounded-lg mb-8">
      <h2 class="text-xl font-bold mb-4">Company Details</h2>
      {companies.map(company => (
        <div class="mb-4 p-3 bg-white rounded border">
          <h3 class="font-bold">{company.slug}</h3>
          <p><strong>Tags:</strong> {company.data.tags?.join(', ') || 'none'}</p>
          <p><strong>Has portfolio tag:</strong> {company.data.tags?.includes('portfolio') ? 'YES' : 'NO'}</p>
          <p><strong>Created:</strong> {company.data.created?.toString() || 'none'}</p>
          <p><strong>Modified:</strong> {company.data.modified?.toString() || 'none'}</p>
        </div>
      ))}
    </div>

    <!-- Test the carousel component -->
    <div class="bg-yellow-100 p-4 rounded-lg">
      <h2 class="text-xl font-bold mb-4">Carousel Component Test</h2>
      <p class="mb-4">The carousel component should appear below. Check the browser console (F12) for client-side logs.</p>
      
      <!-- Import and use the carousel component -->
      <div id="carousel-container">
        <script>
          // Client-side debug
          console.log('=== CLIENT-SIDE DEBUG ===');
          console.log('Page loaded');
          console.log('Companies data available:', {sortedCompanies: JSON.parse('{JSON.stringify(sortedCompanies)}')});
          console.log('=== END CLIENT-SIDE DEBUG ===');
        </script>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Additional client-side debugging
  console.log('=== ADDITIONAL CLIENT DEBUG ===');
  console.log('Script tag executed');
  console.log('Window object available:', typeof window !== 'undefined');
  console.log('Document object available:', typeof document !== 'undefined');
  console.log('=== END ADDITIONAL CLIENT DEBUG ===');
</script> 