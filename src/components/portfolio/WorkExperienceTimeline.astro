---
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';
import Heading from '../ui/Heading.astro';
import WorkExperienceItem from './WorkExperienceItem.astro';

// Get all roles from the local content folder
const roles = await getCollection('roles');

// Sort roles by dateStart date (newest first)
const sortedRoles = roles.sort((a, b) => {
	// Sort by dateStart date, fallback to dateEnd date, then alphabetically
	const dateA = a.data.dateStart || a.data.dateEnd || new Date(0);
	const dateB = b.data.dateStart || b.data.dateEnd || new Date(0);

	if (dateA instanceof Date && dateB instanceof Date) {
		return dateB.getTime() - dateA.getTime();
	}

	// Fallback to alphabetical sorting by slug (filename)
	return a.slug.localeCompare(b.slug);
});

// Show only the first 3 items
const displayedRoles = sortedRoles.slice(0, 3);
const hasMoreItems = sortedRoles.length > 3;
---

<section class="py-8 px-8 max-md:py-4 mb-4 scroll-m-16" id="experience">
	<div class="flex flex-col pt-8 max-w-4xl mx-auto">
		<div class="flex gap-4 items-center justify-center">
			<Icon class="text-3xl dark:text-white text-blacktext" name="briefcase" />
			<Heading text="Work" textGradient="Experience" level={2} />
		</div>

		<div class="relative max-md:mt-0 mt-8 group" aria-label="Professional experience">
			<ol class="relative mt-10">
				{
					displayedRoles.map((role, index) => (
						<li>
							<article
								role="article"
								aria-labelledby={`experience-title-${index}`}>
								<div
									class="flex flex-col gap-2  text-zinc-00 dark:text-zinc-300 md:col-span-3"
									aria-describedby={`experience-title-${index}`}>
									<WorkExperienceItem
										{...role.data}
										name={
											role.data.name ||
											role.id.replace('.md', '')
										}
									/>
								</div>
							</article>
						</li>
					))
				}
			</ol>
			
			{hasMoreItems && (
				<>
					<!-- Fade effect -->
					<div class="pointer-events-none w-full h-32 -mt-32 relative z-10 transition-opacity duration-300 group-hover:opacity-0">
						<div class="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-white via-white/80 to-transparent dark:from-[#121516] dark:via-[#121516]/80"></div>
					</div>
					<!-- See more button below fade -->
					<div class="flex justify-center mt-2 z-20 relative">
						<a 
							href="/work-experience" 
							class="inline-flex items-center px-6 py-3 bg-theme-400 hover:bg-theme-500 text-black font-semibold rounded-lg transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
						>
							See more items
							<svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
							</svg>
						</a>
					</div>
				</>
			)}
		</div>
	</div>
</section>
