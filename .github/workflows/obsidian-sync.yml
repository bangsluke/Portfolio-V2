name: Obsidian Sync & Deploy

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      obsidian_path:
        description: 'Path to Obsidian vault (optional)'
        required: false
        default: ''
      portfolio_tag:
        description: 'Tag to filter for portfolio notes'
        required: false
        default: 'portfolio'
      auto_deploy:
        description: 'Auto-deploy after sync'
        required: false
        default: true
        type: boolean

  # Trigger on push to main branch
  push:
    branches: [main]
    paths:
      - 'src/content/obsidian/**'
      - 'scripts/**'

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for git operations

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Obsidian path and tag
        id: obsidian-config
        run: |
          if [ "${{ github.event.inputs.obsidian_path }}" != "" ]; then
            echo "OBSIDIAN_PATH=${{ github.event.inputs.obsidian_path }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            # For scheduled runs, use default path or skip
            echo "OBSIDIAN_PATH=/tmp/obsidian-vault" >> $GITHUB_ENV
            echo "SKIP_SYNC=true" >> $GITHUB_ENV
          fi

          # Set portfolio tag
          echo "PORTFOLIO_TAG=${{ github.event.inputs.portfolio_tag || 'portfolio' }}" >> $GITHUB_ENV

      - name: Run Obsidian sync
        if: env.SKIP_SYNC != 'true'
        run: |
          if [ "${{ github.event.inputs.auto_deploy }}" == "true" ]; then
            npm run sync:prod:deploy
          else
            npm run sync:prod
          fi
        env:
          OBSIDIAN_PATH: ${{ env.OBSIDIAN_PATH }}
          PORTFOLIO_TAG: ${{ env.PORTFOLIO_TAG }}
          SYNC_MODE: 'production'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build project (if not already built by sync)
        if: env.SKIP_SYNC == 'true' || github.event.inputs.auto_deploy != 'true'
        run: npm run build

      - name: Deploy to Netlify
        if: success()
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 1

      - name: Deploy to Vercel (Alternative)
        if: success() && env.VERCEL_TOKEN != ''
        run: |
          npm install -g vercel
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful"
            # Add notification logic here (Slack, Discord, etc.)
          else
            echo "❌ Deployment failed"
          fi

  # Optional: Mobile sync job (for different platforms)
  mobile-sync:
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.mobile_sync == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run mobile sync
        run: npm run sync:mobile
        env:
          MOBILE: 'true'
          SYNC_MODE: 'mobile'
          OBSIDIAN_PATH: ${{ github.event.inputs.obsidian_path }}

      - name: Upload sync artifacts
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-sync-${{ matrix.os }}
          path: src/content/obsidian/
          retention-days: 1
