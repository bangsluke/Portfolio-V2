---
import { getCollection } from 'astro:content';
import CustomerCarouselComponent from './CustomerCarousel';

// Get all companies from the local content folder
const companies = await getCollection('companies');

// Sort companies by creation date (newest first) and filter for portfolio tag
const sortedCompanies = companies
  .filter(company => {
    // Filter out companies that don't have portfolio tag
    return company.data.tags && company.data.tags.includes('portfolio');
  })
  .sort((a, b) => {
    // Sort by creation date, fallback to modification date, then alphabetically
    const dateA = a.data.created || a.data.modified || new Date(0);
    const dateB = b.data.created || b.data.modified || new Date(0);
    
    if (dateA instanceof Date && dateB instanceof Date) {
      return dateB.getTime() - dateA.getTime();
    }
    
    // Fallback to alphabetical sorting by slug
    return a.slug.localeCompare(b.slug);
  });

// Enhanced debug logging
console.log('=== CUSTOMER CAROUSEL DEBUG ===');
console.log('CustomerCarousel.astro - Total companies found:', companies.length);
console.log('CustomerCarousel.astro - Companies with portfolio tag:', sortedCompanies.length);
console.log('CustomerCarousel.astro - All company slugs:', companies.map(c => c.slug));
console.log('CustomerCarousel.astro - Filtered company slugs:', sortedCompanies.map(c => c.slug));
console.log('CustomerCarousel.astro - First company data:', sortedCompanies[0]);
console.log('CustomerCarousel.astro - Companies JSON length:', JSON.stringify(sortedCompanies).length);
console.log('=== END DEBUG ===');

// Create debug info for visual display
const debugInfo = {
  totalCompanies: companies.length,
  filteredCompanies: sortedCompanies.length,
  companySlugs: sortedCompanies.map(c => c.slug),
  hasData: sortedCompanies.length > 0,
  jsonLength: JSON.stringify(sortedCompanies).length
};
---

<!-- Visual debug info -->
<div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border: 1px solid #ccc; font-family: monospace; font-size: 12px;">
  <strong>DEBUG INFO (Astro Component):</strong><br>
  Total companies: {debugInfo.totalCompanies}<br>
  Filtered companies: {debugInfo.filteredCompanies}<br>
  Company slugs: {debugInfo.companySlugs.join(', ')}<br>
  Has data: {debugInfo.hasData ? 'YES' : 'NO'}<br>
  JSON length: {debugInfo.jsonLength}
</div>

<CustomerCarouselComponent companies={JSON.stringify(sortedCompanies)} /> 