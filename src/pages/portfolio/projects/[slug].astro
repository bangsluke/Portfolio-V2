---
import { getCollection } from 'astro:content';
import CustomerAndClientCarouselItem from '../../../components/portfolio/CustomerAndClientCarouselItem.astro';
import SkillPill from '../../../components/ui/SkillPill.astro';
import Layout from '../../../layouts/Layout.astro';
import { processObsidianLink } from '../../../utils/content-processor';
import { extractNameFromFilename } from '../../../utils/filename-utils';

export async function getStaticPaths() {
	const projects = await getCollection('projects');

	console.log('Processing projects:', projects.length);
	return projects.map(project => {
		// Use name from frontmatter (generated by sync process)
		const projectData = {
			...project.data,
			name: project.data.name,
		};

		return {
			params: { slug: project.slug },
			props: {
				project: {
					...project,
					data: projectData,
				},
			},
		};
	});
}

const { project } = Astro.props;
const { data } = project;

console.log(data);

// Get linked companies and clients
let linkedCompanies: any[] = [];
let linkedClients: any[] = [];

try {
	const companies = await getCollection('companies');
	const clients = await getCollection('clients');

	// Check each linked company/client
	(data.linkedCompany || []).forEach(linkedItem => {
		const linkedName = processObsidianLink(linkedItem);

		// First try to find in companies
		const company = companies.find(
			company => extractNameFromFilename(company.id) === linkedName
		);

		if (company) {
			linkedCompanies.push(company);
		} else {
			// If not found in companies, try clients
			const client = clients.find(
				client => extractNameFromFilename(client.id) === linkedName
			);

			if (client) {
				linkedClients.push(client);
			}
		}
	});
} catch (error) {
	console.error('Error fetching linked companies/clients:', error);
}

// Helper to get company name from frontmatter or fallback to filename minus extension
function getCompanyName(company: any) {
	if (company.data.name && company.data.name.trim() !== '') {
		return company.data.name;
	}
	// Fallback to filename minus .md extension
	return extractNameFromFilename(company.id);
}

// Helper to format date range for display
function formatDateRange(dateStart: any, dateEnd: any) {
	if (!dateStart) return '';

	const startDate = new Date(dateStart).toLocaleDateString('en-US', {
		month: 'short',
		year: 'numeric',
	});

	// Check if dateEnd is falsy, empty, or a non-date value like "TBD"
	if (
		!dateEnd ||
		dateEnd === '' ||
		dateEnd === 'TBD' ||
		isNaN(new Date(dateEnd).getTime())
	) {
		return `${startDate} - Present`;
	}

	const endDate = new Date(dateEnd).toLocaleDateString('en-US', {
		month: 'short',
		year: 'numeric',
	});

	return `${startDate} - ${endDate}`;
}

const pageTitle = data.name + ' Project - bangsluke Portfolio';
const description = data.shortDescription;
const ogimage = {
	url: '/images/imagedefault.webp',
	alt: data.name + ' Project - bangsluke Portfolio',
};
---

<Layout pageTitle={pageTitle} description={description} ogimage={ogimage}>
	<div class="min-h-screen bg-white dark:bg-gray-900">
		<!-- Top Back Button -->
		<div class="py-8 px-8">
			<div class="max-w-4xl mx-auto">
				<div class="text-center">
					<a
						href="/site#projects"
						class="inline-flex items-center text-theme-400 hover:text-theme-300 transition-colors">
						<svg
							class="w-5 h-5 mr-2"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M15 19l-7-7 7-7"></path>
						</svg>
						Back to Projects
					</a>
				</div>
			</div>
		</div>

		<!-- Project Image -->
		<div class="px-8 mb-8">
			<div class="max-w-5xl mx-auto">
				<div class="flex justify-center">
					<img
						src={data.imageURL || '/images/imagedefault.webp'}
						alt={data.name}
						class="w-full max-w-5xl h-[422px] object-cover object-top rounded-2xl shadow-2xl"
					/>
				</div>
			</div>
		</div>

		<!-- Project Name, Date Range, and Technologies -->
		<div class="px-8 mb-12">
			<div class="max-w-4xl mx-auto">
				<div class="text-center">
					<h1 class="text-5xl font-bold mb-4 text-theme-100">{data.name}</h1>

					{/* Date Range */}
					{
						data.dateStart && (
							<div class="mb-6">
								<p class="text-lg text-gray-300">
									{new Date(data.dateStart).toLocaleDateString('en-US', {
										month: 'short',
										year: 'numeric',
									})}{' '}
									{data.dateEnd
										? `- ${new Date(data.dateEnd).toLocaleDateString('en-US', {
												month: 'short',
												year: 'numeric',
											})}`
										: '- Present'}
								</p>
							</div>
						)
					}

					{/* Project Category */}
					{
						data.projectCategory && (
							<div class="mb-6">
								<span class="text-lg text-gray-300 mr-3">Category:</span>
								<a
									href={`/portfolio/projects?category=${encodeURIComponent(data.projectCategory)}`}
									class="inline-block bg-theme-400 hover:bg-theme-500 text-black font-bold px-4 py-2 rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg">
									{data.projectCategory}
								</a>
							</div>
						)
					}

					{/* Technologies */}
					<div class="flex flex-wrap justify-center gap-3">
						{
							data.technologies &&
								data.technologies.map((tech: string) => {
									const cleanTech = tech.replace(/\[|\]/g, '');
									return (
										<SkillPill
											skillName={cleanTech}
											variant="theme"
											size="md"
											className="shadow-lg"
										/>
									);
								})
						}
					</div>
				</div>
			</div>
		</div>

		<!-- Description Section -->
		{
			data.longDescription && (
				<section class="px-8 mb-12">
					<div class="max-w-4xl mx-auto">
						<h2 class="text-3xl font-bold mb-6 text-theme-100">Description</h2>
						<div class="bg-gradient-to-br from-[#1a232a] to-[#10151a] rounded-2xl p-8 shadow-lg">
							<div
								class="text-lg text-zinc-200 leading-relaxed processed-content"
								set:html={data.longDescription}
							/>
						</div>
					</div>
				</section>
			)
		}

		<!-- Lessons Learned Section -->
		{
			data.lessonsLearned && (
				<section class="px-8 mb-12">
					<div class="max-w-4xl mx-auto">
						<h2 class="text-3xl font-bold mb-6 text-theme-100">
							Lessons Learned
						</h2>
						<div class="bg-gradient-to-br from-[#1a232a] to-[#10151a] rounded-2xl p-8 shadow-lg">
							<div
								class="text-lg text-zinc-200 leading-relaxed processed-content"
								set:html={data.lessonsLearned}
							/>
						</div>
					</div>
				</section>
			)
		}

		<!-- Linked Company/Client Section -->
		{
			data.linkedCompany &&
				data.linkedCompany.length > 0 &&
				(linkedCompanies.length > 0 || linkedClients.length > 0) && (
					<section class="px-8 mb-12">
						<div class="max-w-4xl mx-auto">
							<div class="text-center">
								<h2 class="text-3xl font-bold mb-6 text-theme-100">
									Developed For
								</h2>
								<div class="flex flex-wrap justify-center gap-6">
									{linkedCompanies.map(company => (
										<CustomerAndClientCarouselItem
											name={getCompanyName(company)}
											logoURL={company.data.logoURL || undefined}
										/>
									))}
									{linkedClients.map(client => (
										<CustomerAndClientCarouselItem
											name={getCompanyName(client)}
											logoURL={client.data.logoURL || undefined}
										/>
									))}
								</div>
							</div>
						</div>
					</section>
				)
		}

		<!-- Project Links -->
		{
			(data.projectURL || data.codeURL) && (
				<section class="px-8 mb-12">
					<div class="max-w-4xl mx-auto">
						<div class="text-center">
							<span class="text-lg text-gray-300 mr-4">Project Links:</span>
							<div class="inline-flex flex-wrap gap-4 justify-center">
								{data.projectURL && (
									<a
										href={data.projectURL}
										target="_blank"
										rel="noopener noreferrer"
										class="bg-theme-400 hover:bg-theme-500 text-black font-bold px-8 py-3 rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg inline-flex items-center">
										<svg
											class="w-5 h-5 mr-2"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
											/>
										</svg>
										Visit Site
									</a>
								)}
								{data.codeURL && (
									<a
										href={data.codeURL}
										target="_blank"
										rel="noopener noreferrer"
										class="bg-[#232b32] hover:bg-theme-700/30 text-theme-100 font-bold px-8 py-3 rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg inline-flex items-center">
										<svg
											class="w-5 h-5 mr-2"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
											/>
										</svg>
										View Code
									</a>
								)}
							</div>
						</div>
					</div>
				</section>
			)
		}

		<!-- Bottom Back Button -->
		<div class="px-8 py-8">
			<div class="max-w-4xl mx-auto">
				<div class="text-center">
					<a
						href="/site#projects"
						class="inline-flex items-center text-theme-400 hover:text-theme-300 transition-colors">
						<svg
							class="w-5 h-5 mr-2"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M15 19l-7-7 7-7"></path>
						</svg>
						Back to Projects
					</a>
				</div>
			</div>
		</div>
	</div>
</Layout>
