---
import { Icon } from 'astro-icon/components';
// @ts-expect-error - AstroError is not typed
import { AstroError } from 'astro/errors';
import { getCollection } from 'astro:content';

import GitHubContributions from '../portfolio/GitHubContributions.js';
import MostCommonTechs from '../portfolio/MostCommonTechs.astro';
import SkillsBubbles from '../portfolio/SkillsBubbles.astro';
import Heading from '../ui/Heading.astro';
import {
	getProjectCount,
	getProjectsUsingSkill,
} from '../../utils/project-count-utils';
import { extractNameFromFilename } from '../../utils/filename-utils';

const [staticData] = await getCollection('staticData');
const skills = await getCollection('skills');

if (!staticData) {
	throw new AstroError('JSON data not found');
}

// Process tech data for MostCommonTechs component
const projects = await getCollection('projects');

// Create an array of tech objects instead of separate objects
const techsArray: Array<{
	name: string;
	count: number;
	projects: string[];
	tags: string[];
}> = [];

// Get all unique technologies from projects
const allTechnologies = new Set<string>();
projects.forEach(project => {
	if (!project || !project.data) {
		return;
	}
	if (project.data.technologies) {
		project.data.technologies.forEach((tech: string) => {
			// Clean the technology name by removing Obsidian brackets
			const cleanTech = tech.replace(/\[\[|\]\]/g, '');

			// Skip "n/a" technologies
			if (cleanTech.toLowerCase() === 'n/a') {
				return;
			}

			allTechnologies.add(cleanTech);
		});
	}
});

// Count technology usage across all projects and find matching skills
allTechnologies.forEach(tech => {
	const count = getProjectCount(tech, tech, projects);
	const projectsList = getProjectsUsingSkill(tech, tech, projects);

	// Improved skill matching logic
	let skillData: typeof skills[0] | null = null;
	let tags: string[] = [];

	// Try exact match first (case-insensitive)
	skillData = skills.find(
		s => (s.data.name || s.slug).toLowerCase() === tech.toLowerCase()
	);

	// If no exact match, try normalized matches (remove special characters)
	if (!skillData) {
		const normalizedTech = tech.toLowerCase().replace(/[^a-z0-9]/g, '');
		skillData = skills.find(s => {
			const skillName = (s.data.name || s.slug)
				.toLowerCase()
				.replace(/[^a-z0-9]/g, '');
			return skillName === normalizedTech;
		});
	}

	// If still no match, try partial matches
	if (!skillData) {
		skillData = skills.find(s => {
			const skillName = (s.data.name || s.slug).toLowerCase();
			const techLower = tech.toLowerCase();

			// Check if skill name contains tech or vice versa
			return skillName.includes(techLower) || techLower.includes(skillName);
		});
	}

	// If still no match, try checking aliases
	if (!skillData) {
		skillData = skills.find(s => {
			const aliases = (s.data as any).aliases;
			return (
				aliases &&
				Array.isArray(aliases) &&
				aliases.some(
					(alias: string) => alias.toLowerCase() === tech.toLowerCase()
				)
			);
		});
	}

	if (skillData) {
		tags = skillData.data.tags || [];
	}

	// Add to techs array
	techsArray.push({
		name: tech,
		count,
		projects: projectsList,
		tags,
	});
});

// Sort by count (most used first)
techsArray.sort((a, b) => b.count - a.count);

// Create the final data structure
const techData = {
	techs: techsArray,
};
---

<section
	class="main-section pt-8 pb-12 md:pt-16"
	id="skills"
	aria-label="Coding section">
	<div class="flex gap-4 items-center justify-center mb-6">
		<Icon class="text-3xl dark:text-white text-blacktext" name="code" />
		<Heading text="Coding " textGradient="Skills" level={2} />
	</div>

	<!-- SEO-accessible skills summary for web crawlers -->
	<div class="sr-only" aria-hidden="true">
		<h3>Complete Technical Skills List</h3>
		<p>Professional skills and technologies I work with, organized by category:</p>
		
		<h4>Programming Languages</h4>
		<ul>
			{skills.filter(s => s.data.tags?.includes('language')).map(skill => (
				<li><strong>{skill.data.name || skill.slug}</strong>: {skill.data.skillDescription?.replace(/<[^>]*>/g, '') || 'Programming language'}</li>
			))}
		</ul>
		
		<h4>Frontend Technologies</h4>
		<ul>
			{skills.filter(s => s.data.tags?.includes('framework') || s.data.tags?.includes('library')).map(skill => (
				<li><strong>{skill.data.name || skill.slug}</strong>: {skill.data.skillDescription?.replace(/<[^>]*>/g, '') || 'Frontend technology'}</li>
			))}
		</ul>
		
		<h4>Development Tools</h4>
		<ul>
			{skills.filter(s => s.data.tags?.includes('tool') || s.data.tags?.includes('software')).map(skill => (
				<li><strong>{skill.data.name || skill.slug}</strong>: {skill.data.skillDescription?.replace(/<[^>]*>/g, '') || 'Development tool'}</li>
			))}
		</ul>
		
		<h4>Cloud & Platforms</h4>
		<ul>
			{skills.filter(s => s.data.tags?.includes('cloud') || s.data.tags?.includes('platform')).map(skill => (
				<li><strong>{skill.data.name || skill.slug}</strong>: {skill.data.skillDescription?.replace(/<[^>]*>/g, '') || 'Cloud platform'}</li>
			))}
		</ul>
		
		<h4>All Skills</h4>
		<p>Complete list of {skills.length} technical skills:</p>
		<ul>
			{skills.map(skill => (
				<li><strong>{skill.data.name || skill.slug}</strong></li>
			))}
		</ul>
	</div>

	<div
		id="coding-section-layout"
		class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mx-auto max-w-7xl max-sm:gap-3 gap-4">
		<!-- Skills Bubbles - First element - takes up 2 rows on mobile, full first column on desktop -->
		<div
			class="row-span-2 md:col-span-1 rounded-2xl bg-linear-to-r from-theme-300 dark:from-theme-600 to-theme-50 dark:to-theme-200/5 hover:to-theme-300/30 dark:hover:to-theme-600/30 p-[.2rem] transition-all hover:shadow-[0_20px_50px_var(--color-theme-500-rgba-04)] dark:before:bg-[radial-gradient(circle,var(--color-theme-500)_0,var(--color-theme-950)_100%)] before:bg-[radial-gradient(circle,var(--color-theme-300)_0,var(--color-theme-200)_100%)] before:absolute before:left-1/2 before:bottom-30 before:h-[30%] before:aspect-square before:rounded-full before:blur-3xl before:opacity-70 before:transition before:-z-0 hover:before:animate-pulse xl:before:bottom-2/5 min-h-[400px] md:min-h-[450px]">
			<article
				class="group relative flex h-full flex-col justify-start overflow-hidden rounded-2xl bg-linear-to-tr from-light-theme-accent-100 to-theme-100 p-4 md:p-6 transition hover:shadow-[0_10px_50px_var(--color-theme-500-rgba-02)] dark:bg-linear-to-r dark:from-theme-900 dark:to-theme-950 dark:overflow-hidden">
				<!-- Header row - Skills title and buttons -->
				<div
					class="flex items-center justify-between gap-4 max-md:gap-2 mb-4 flex-shrink-0">
					<div class="flex items-center gap-4 max-md:gap-2">
						<Icon
							class="text-3xl dark:text-white text-theme-500 max-md:text-2xl max-sm:text-sm"
							name="skill"
							aria-hidden="true"
						/>
						<Heading text="Skills" textGradient="" level={3} />
					</div>
					<div class="flex items-center gap-2">
						<!-- Reset Button -->
						<button
							id="skills-reset-btn"
							class="global-element global-button global-clear-button"
							title="Reset to default view - center graph and reset to skill rating sizing">
							Reset
						</button>

						<!-- Combined Toggle Button - Three States -->
						<button
							id="skills-toggle-btn"
							class="global-element global-button"
							title="Toggle between bubble chart (skill rating), bubble chart (project count), and list view">
							Toggle: Bubbles (Skill)
						</button>
					</div>
				</div>

				<!-- Content area - fills remaining space -->
				<div class="flex-1 min-h-0 relative">
					<!-- Skills Bubbles View -->
					<div id="skills-bubbles-view" class="h-full">
						<SkillsBubbles />
					</div>

					<!-- Skills Table View - Always visible to web crawlers but visually hidden for users -->
					<div
						id="skills-table-view"
						class="block md:hidden bg-white dark:bg-theme-950 rounded-2xl p-2 md:p-6 overflow-hidden">
						<div class="overflow-y-auto h-full">
							<!-- Skills Table View layout -->
							<div class="block space-y-3">
								{
									skills
										.sort(
											(a, b) =>
												(b.data.skillRating || 0) - (a.data.skillRating || 0)
										)
										.map(skill => (
											<div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
												<!-- Top row: Name, Logo, Rating, Project Count -->
												<div class="flex items-center justify-between gap-3 mb-2 h-6">
													<!-- Name -->
													<div class="flex flex-col items-center gap-1 min-w-0 shrink-0">
														<div class="text-xs font-medium text-colour">
															{extractNameFromFilename(skill.id || skill.slug)}
														</div>
													</div>
													<!-- Logo -->
													{skill.data.logoFileName && (
														<div class="flex-1 flex justify-start">
											<img
												src={`/icons/${skill.data.logoFileName}`}
												alt={`${skill.data.name || skill.slug} icon`}
												class="h-full w-auto max-h-6"
											/>
											</div>
									)}
													<!-- Rating -->
													<div class="flex gap-3 text-xs text-colour">
														<div class="text-center">
															<div class="text-gray-500 dark:text-gray-400">Rating</div>
															<div class="font-medium">
																{skill.data.skillRating || '-'}
															</div>
														</div>
														<div class="text-center">
															<div class="text-center">
																<div class="text-gray-500 dark:text-gray-400">Projects</div>
																<div class="font-medium">
																	{(() => {
																		const skillName = skill.data.name || skill.slug;
																		return projects.filter(project =>
																			project.data.technologies?.some(
																				(tech: string) => {
																					const cleanTech = tech.replace(/\[\[|\]\]/g, '');
																					return cleanTech.toLowerCase() === skillName.toLowerCase();
																				}
																			)
																		).length;
																	})()}
																</div>
															</div>
														</div>
													</div>
												</div>
								<!-- Second row: Description -->
								<div class="flex items-start">
									
									{skill.data.skillDescription && skill.data.skillDescription !== '-' && (
										<div class="text-xs text-colour opacity-80 flex-1">
											{skill.data.skillDescription}
										</div>
									)}
								</div>
							</div>
						))
					}
				</div>
						</div>
					</div>
				</div>
			</article>
		</div>

		<!-- GitHub Contributions - Second element - takes up 1 row on mobile, first row of second column on desktop -->
		<div
			class="row-span-1 md:col-span-1 rounded-2xl bg-linear-to-r from-theme-300 dark:from-theme-600 to-theme-50 dark:to-theme-200/5 hover:to-theme-300/30 dark:hover:to-theme-600/30 p-[.2rem] transition-all hover:shadow-[0_20px_50px_var(--color-theme-500-rgba-04)] dark:before:bg-[radial-gradient(circle,var(--color-theme-500)_0,var(--color-theme-950)_100%)] before:bg-[radial-gradient(circle,var(--color-theme-300)_0,var(--color-theme-200)_100%)] before:absolute before:left-1/2 before:bottom-30 before:h-[30%] before:aspect-square before:rounded-full before:blur-3xl before:opacity-70 before:transition before:-z-0 hover:before:animate-pulse xl:before:bottom-2/5 min-h-[200px] md:min-h-[200px]">
			<article
				class="group relative z-0 flex h-full w-full flex-col overflow-hidden rounded-2xl bg-linear-to-tr from-light-theme-accent-100 to-theme-100 p-4 md:p-6 transition hover:shadow-[0_10px_50px_rgba(13,188,130,0.2)] dark:bg-linear-to-r dark:from-theme-900 dark:to-theme-950 dark:overflow-hidden">
				<div class="flex items-center gap-4 max-md:gap-2 mb-4">
					<Icon
						class="text-3xl dark:text-white text-theme-500 max-md:text-2xl max-sm:text-sm"
						name="github"
						aria-hidden="true"
					/>
					<Heading text="GitHub" textGradient="Contributions" level={3} />
				</div>
				<div id="github-contributions" class="w-full">
					<GitHubContributions client:only="preact" />
				</div>
			</article>
		</div>

		<!-- Most Common Techs Used - Third element - takes up 1 row on mobile, second row of second column on desktop -->
		<div
			class="row-span-1 md:col-span-1 rounded-2xl bg-linear-to-r from-theme-300 dark:from-theme-600 to-theme-50 dark:to-theme-200/5 hover:to-theme-300/30 dark:hover:to-theme-600/30 p-[.2rem] transition-all hover:shadow-[0_20px_50px_var(--color-theme-500-rgba-04)] dark:before:bg-[radial-gradient(circle,var(--color-theme-500)_0,var(--color-theme-950)_100%)] before:bg-[radial-gradient(circle,var(--color-theme-300)_0,var(--color-theme-200)_100%)] before:absolute before:left-1/2 before:bottom-30 before:h-[30%] before:aspect-square before:rounded-full before:blur-3xl before:opacity-70 before:transition before:-z-0 hover:before:animate-pulse xl:before:bottom-2/5 min-h-[250px] md:min-h-[280px]">
			<article
				class="group relative z-0 flex h-full w-full flex-col overflow-hidden rounded-2xl bg-linear-to-tr from-light-theme-accent-100 to-theme-100 p-4 md:p-6 transition hover:shadow-[0_10px_50px_var(--color-theme-500-rgba-02)] dark:bg-linear-to-r dark:from-theme-900 dark:to-theme-950 dark:overflow-hidden">
				<!-- Header row - Techs title only -->
				<div class="flex items-center gap-4 max-md:gap-2 mb-2 flex-shrink-0">
					<Icon
						class="text-3xl dark:text-white text-theme-500 max-md:text-2xl max-sm:text-sm"
						name="tech"
						aria-hidden="true"
					/>
					<Heading text="Most Common" textGradient="Techs" level={3} />
				</div>

				<!-- Content area - fills remaining space -->
				<div class="flex-1 min-h-0">
					<MostCommonTechs techData={techData} />
				</div>
			</article>
		</div>
	</div>
</section>

<script>
	// Skills section button functionality
	document.addEventListener('DOMContentLoaded', () => {
		const resetBtn = document.getElementById('skills-reset-btn');
		const toggleBtn = document.getElementById('skills-toggle-btn');
		let currentView = 'bubbles-skill'; // 'bubbles-skill', 'bubbles-project', 'list'

		// Initialize view state - show bubbles (skill rating)
		const bubblesView = document.getElementById('skills-bubbles-view');
		const tableView = document.getElementById('skills-table-view');
		if (bubblesView && tableView) {
			bubblesView.classList.remove('hidden');
			tableView.classList.add('hidden');
		}

		// Reset button functionality
		if (resetBtn) {
			resetBtn.addEventListener('click', () => {
				// Reset to default view (bubbles skill)
				currentView = 'bubbles-skill';
				if (toggleBtn) {
					toggleBtn.textContent = 'Toggle: Bubbles (Skill)';
					toggleBtn.title =
						'Toggle between bubble chart (skill rating), bubble chart (project count), and list view';
				}

				// Dispatch event for the Preact component
				window.dispatchEvent(
					new CustomEvent('skillsReset', {
						detail: { currentView },
					})
				);
			});
		}

		// Combined Toggle Button functionality
		if (toggleBtn) {
			toggleBtn.addEventListener('click', () => {
				if (currentView === 'bubbles-skill') {
					currentView = 'bubbles-project';
					toggleBtn.textContent = 'Toggle: Bubbles (Project)';
					toggleBtn.title =
						'Toggle between bubble chart (project count) and list view';
					if (bubblesView) bubblesView.classList.remove('hidden');
					if (tableView) tableView.classList.add('hidden');
				} else if (currentView === 'bubbles-project') {
					currentView = 'list';
					toggleBtn.textContent = 'Toggle: List';
					toggleBtn.title = 'Show list view';
					if (bubblesView) bubblesView.classList.add('hidden');
					if (tableView) tableView.classList.remove('hidden');
				} else {
					// currentView === 'list'
					currentView = 'bubbles-skill';
					toggleBtn.textContent = 'Toggle: Bubbles (Skill)';
					toggleBtn.title =
						'Toggle between bubble chart (skill rating) and list view';
					if (bubblesView) bubblesView.classList.remove('hidden');
					if (tableView) tableView.classList.add('hidden');
				}

				// Dispatch event for the Preact component
				window.dispatchEvent(
					new CustomEvent('skillsViewToggle', {
						detail: { currentView },
					})
				);
			});
		}
	});
</script>
