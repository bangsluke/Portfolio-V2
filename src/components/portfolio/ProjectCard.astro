---
import {
	processContent,
	processObsidianLink,
} from '../../utils/content-processor';
import SkillPill from '../ui/SkillPill.astro';

const {
	name,
	imageURL,
	technologies,
	shortDescription,
	slug,
	companyLogoURL,
	linkedCompany,
} = Astro.props;

// Process content to handle Obsidian links and markdown
const processedShortDescription = processContent(shortDescription || '');

function getSlug(str: string) {
	return str
		.toLowerCase()
		.replace(/[^a-z0-9]+/g, '-')
		.replace(/(^-|-$)/g, '');
}

// Extract company name from linkedCompany array
let companyName = null;
if (linkedCompany && linkedCompany.length > 0) {
	const linkedCompanyRaw = linkedCompany[0];
	const extractedName = processObsidianLink(linkedCompanyRaw);
	// Only show if it's not "n/a" or blank
	if (
		extractedName &&
		extractedName.toLowerCase() !== 'n/a' &&
		extractedName.trim() !== ''
	) {
		companyName = extractedName;
	}
}

const projectSlug = slug || getSlug(name);

// Process technologies for display
const MAX_VISIBLE_SKILLS = 5;
const visibleTechnologies = technologies
	? technologies.slice(0, MAX_VISIBLE_SKILLS)
	: [];
const hiddenTechnologies = technologies
	? technologies.slice(MAX_VISIBLE_SKILLS)
	: [];
const hasHiddenSkills = hiddenTechnologies.length > 0;
---

<article
	class="project-card group bg-gradient-to-br from-[#1a232a] to-[#10151a] rounded-2xl shadow-lg p-0 flex flex-col overflow-hidden transition-transform hover:scale-105 duration-300 min-h-[420px]"
	data-slug={projectSlug}>
	<div class="relative w-full h-48">
		<img
			src={imageURL || '/images/imagedefault.webp'}
			alt={name}
			class="w-full h-48 object-cover object-top rounded-t-2xl"
			loading="lazy"
		/>
		<div
			class="absolute inset-0 bg-black/70 group-hover:bg-transparent transition-all duration-300 pointer-events-none">
		</div>
		<a
			href={`/portfolio/projects/${projectSlug}`}
			class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-all duration-300 bg-theme-400 hover:bg-theme-500 text-black rounded-full p-2 shadow-lg z-10 flex items-center justify-center"
			aria-label={`View details for ${name}`}
			title={`View details for ${name}`}>
			<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
				><path
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
				></path></svg
			>
		</a>
	</div>
	<div class="flex flex-col flex-1 p-6">
		<h2 class="text-2xl font-bold text-theme-100 mb-3">{name}</h2>
		<div class="flex flex-wrap gap-2 mb-4">
			{
				visibleTechnologies &&
					visibleTechnologies.map((tech: string) => {
						const cleanTech = tech.replace(/\[|\]/g, '');
						return (
							<SkillPill
								skillName={cleanTech}
								variant="dark"
								size="sm"
								className="shadow hover:bg-theme-700/30"
							/>
						);
					})
			}
			{
				hasHiddenSkills && (
					<div class="relative group/tooltip">
						<div class="flex items-center justify-center w-8 h-8 bg-theme-400/20 border border-theme-400/30 rounded-full text-theme-400 hover:bg-theme-400/30 transition-colors duration-200 cursor-help">
							<span class="text-sm font-medium">
								+{hiddenTechnologies.length}
							</span>
						</div>
						<div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 opacity-0 group-hover/tooltip:opacity-100 group-active/tooltip:opacity-100 transition-opacity duration-200 pointer-events-none z-50 w-[250px] max-w-[90vw]">
							<div class="bg-[#1a232a] border border-theme-400/30 rounded-lg p-3 shadow-lg w-full">
								<div class="text-xs text-theme-400 font-medium mb-2">
									Additional technologies:
								</div>
								<div class="flex flex-wrap gap-2">
									{hiddenTechnologies.map((tech: string) => {
										const cleanTech = tech.replace(/\[|\]/g, '');
										return (
											<SkillPill
												skillName={cleanTech}
												variant="dark"
												size="sm"
												className="shadow hover:bg-theme-700/30"
											/>
										);
									})}
								</div>
							</div>
						</div>
					</div>
				)
			}
		</div>
		<div
			class="text-zinc-300 text-base flex-1 mb-4 processed-content"
			set:html={processedShortDescription}
		/>

		{
			companyName && (
				<div class="mt-auto pt-4 border-t border-zinc-700">
					<div class="relative group/tooltip">
						<span class="text-sm text-zinc-300">
							Developed for:{' '}
							<span class="text-theme-400 hover:text-theme-300 transition-colors cursor-help">
								{companyName}
							</span>
						</span>
						{companyLogoURL && (
							<div class="absolute bottom-full left-0 mb-2 opacity-0 group-hover/tooltip:opacity-100 transition-opacity duration-200 pointer-events-none z-20">
								<div class="bg-[#1a232a] border border-theme-400/30 rounded-lg p-3 shadow-lg">
									<div class="flex items-center gap-3">
										<img
											src={companyLogoURL}
											alt={`${companyName} logo`}
											class="w-12 h-12 object-contain rounded"
										/>
										<span class="text-white font-medium text-sm whitespace-nowrap">
											{companyName}
										</span>
									</div>
								</div>
							</div>
						)}
					</div>
				</div>
			)
		}

		<!-- Mobile "See more detail..." link -->
		<div
			class="mobile-detail-link hidden md:hidden mt-4 pt-4 border-t border-zinc-700">
			<a
				href={`/portfolio/projects/${projectSlug}`}
				class="flex items-center justify-center gap-2 text-theme-400 hover:text-theme-300 transition-colors text-sm font-medium">
				<span>See more detail...</span>
				<svg
					class="w-4 h-4"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24">
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M9 5l7 7-7 7"></path>
				</svg>
			</a>
		</div>
	</div>
</article>

<script>
	// Handle mobile touch events for project cards
	document.addEventListener('DOMContentLoaded', function () {
		const projectCards = document.querySelectorAll('.project-card');
		let selectedCard: HTMLElement | null = null;

		projectCards.forEach(card => {
			// Handle touch start for card selection
			card.addEventListener(
				'touchstart',
				function (this: HTMLElement, e: Event) {
					e.preventDefault();

					// Deselect previously selected card
					if (selectedCard && selectedCard !== this) {
						selectedCard.classList.remove('card-selected');
						const prevDetailLink = selectedCard.querySelector(
							'.mobile-detail-link'
						);
						if (prevDetailLink) {
							prevDetailLink.classList.add('hidden');
						}
					}

					// Toggle selection for current card
					if (this.classList.contains('card-selected')) {
						// Deselect
						this.classList.remove('card-selected');
						const detailLink = this.querySelector('.mobile-detail-link');
						if (detailLink) {
							detailLink.classList.add('hidden');
						}
						selectedCard = null;
					} else {
						// Select
						this.classList.add('card-selected');
						const detailLink = this.querySelector('.mobile-detail-link');
						if (detailLink) {
							detailLink.classList.remove('hidden');
						}
						selectedCard = this;
					}
				}
			);

			// Handle mouse leave (for desktop)
			card.addEventListener('mouseleave', function (this: HTMLElement) {
				this.classList.remove('group-hover');
			});
		});

		// Handle mobile touch events for tooltips
		const tooltipTriggers = document.querySelectorAll('.group\\/tooltip');

		tooltipTriggers.forEach(trigger => {
			let tooltipActive = false;

			// Handle touch start for tooltip
			trigger.addEventListener(
				'touchstart',
				function (this: HTMLElement, e: Event) {
					const touchEvent = e as TouchEvent;
					touchEvent.preventDefault();
					touchEvent.stopPropagation();

					if (tooltipActive) {
						// Hide tooltip if already active
						this.classList.remove('group-active/tooltip');
						tooltipActive = false;
					} else {
						// Show tooltip
						this.classList.add('group-active/tooltip');
						tooltipActive = true;

						// Hide tooltip after 3 seconds
						setTimeout(() => {
							this.classList.remove('group-active/tooltip');
							tooltipActive = false;
						}, 3000);
					}
				}
			);

			// Handle click outside to close tooltip
			document.addEventListener('click', function (e: Event) {
				if (!trigger.contains(e.target as Node)) {
					trigger.classList.remove('group-active/tooltip');
					tooltipActive = false;
				}
			});
		});

		// Handle click outside to deselect cards
		document.addEventListener('click', function (e: Event) {
			const target = e.target as HTMLElement;
			if (!target.closest('.project-card')) {
				if (selectedCard) {
					selectedCard.classList.remove('card-selected');
					const detailLink = selectedCard.querySelector('.mobile-detail-link');
					if (detailLink) {
						detailLink.classList.add('hidden');
					}
					selectedCard = null;
				}
			}
		});
	});
</script>

<style>
	@media (max-width: 768px) {
		.group .absolute.top-3.right-3 {
			opacity: 1 !important;
		}
	}

	/* Custom hover class for mobile */
	.group-hover .absolute.inset-0 {
		background-color: transparent !important;
	}

	.group-hover .absolute.top-3.right-3 {
		opacity: 1 !important;
	}

	/* Card selection styles for mobile */
	.card-selected {
		transform: scale(1.02) !important;
		box-shadow: 0 0 20px rgba(49, 214, 154, 0.3) !important;
		border: 2px solid #31d69a !important;
	}

	.card-selected .absolute.inset-0 {
		background-color: transparent !important;
	}

	.card-selected .absolute.top-3.right-3 {
		opacity: 1 !important;
	}

	/* Mobile detail link animation */
	.mobile-detail-link {
		animation: slideIn 0.3s ease-out;
	}

	@keyframes slideIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
