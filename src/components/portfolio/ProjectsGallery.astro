---
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';
import {
	getPortfolioConfigValue,
	processObsidianLink,
} from '../../utils/content-processor';
import { extractNameFromFilename } from '../../utils/filename-utils';
import Heading from '../ui/Heading.astro';
import ProjectCard from './ProjectCard.astro';

// Get all projects, companies, clients, and educations from the local content folders
const projects = await getCollection('projects');
const companies = await getCollection('companies');
const clients = await getCollection('clients');
const educations = await getCollection('educations');

// Get portfolio configuration with fallback
let maxProjectsDisplay = 6;
try {
	maxProjectsDisplay =
		(await getPortfolioConfigValue('maxProjectsDisplay', 6)) || 6;
} catch (error) {
	console.error('Error getting portfolio config:', error);
	maxProjectsDisplay = 6; // Fallback to default
}

// Sort projects by portfolioOrder first, then dateStart, then alphabetically
const sortedProjects = projects.sort((a, b) => {
	// Get portfolioOrder values (default to 999 if not set)
	const orderA = a.data.portfolioOrder || 999;
	const orderB = b.data.portfolioOrder || 999;

	// First, sort by portfolioOrder (numerically)
	if (orderA !== orderB) {
		return orderA - orderB;
	}

	// If portfolioOrder is the same, sort by dateStart (chronologically)
	const dateA = a.data.dateStart || new Date(0);
	const dateB = b.data.dateStart || new Date(0);

	const dateAValue =
		dateA instanceof Date ? dateA.getTime() : new Date(dateA).getTime();
	const dateBValue =
		dateB instanceof Date ? dateB.getTime() : new Date(dateB).getTime();

	if (dateAValue !== dateBValue) {
		return dateBValue - dateAValue; // Newest dates first
	}

	// If dates are the same, fallback to alphabetical sorting by slug
	return a.slug.localeCompare(b.slug);
});

// Process projects to include company/client/education logos
const processedProjects = sortedProjects.map(project => {
	let companyLogoURL = null;

	// If project has linkedCompany, find the company, client, or education and get its logoURL
	if (project.data.linkedCompany && project.data.linkedCompany.length > 0) {
		// Get the first linked company and process Obsidian link format
		const linkedCompanyRaw = project.data.linkedCompany[0];
		const linkedCompanyName = processObsidianLink(linkedCompanyRaw);

		// First try to find in companies collection
		const company = companies.find(company => {
			const companyName = extractNameFromFilename(company.id);
			return companyName === linkedCompanyName;
		});

		if (company && company.data.logoURL) {
			companyLogoURL = company.data.logoURL;
		} else {
			// If not found in companies, try clients collection
			const client = clients.find(client => {
				const clientName = extractNameFromFilename(client.id);
				return clientName === linkedCompanyName;
			});

			if (client && client.data.logoURL) {
				companyLogoURL = client.data.logoURL;
			} else {
				// If not found in clients, try educations collection
				const education = educations.find(education => {
					const educationName = extractNameFromFilename(education.id);
					return educationName === linkedCompanyName;
				});

				if (education && education.data.logoURL) {
					companyLogoURL = education.data.logoURL;
				}
			}
		}
	}

	return {
		...project,
		shortDescription: project.data.shortDescription,
		companyLogoURL,
	};
});

// Show projects based on configuration
const displayedProjects = processedProjects.slice(0, maxProjectsDisplay);
---

<section class="main-section pt-8 pb-12 md:pt-12" id="projects">
	<div class="flex flex-col max-w-7xl mx-auto">
		<div class="flex gap-4 items-center justify-center mb-6 md:mb-0">
			<Icon class="text-3xl dark:text-white text-blacktext" name="dashboard" />
			<Heading text="" textGradient="Projects " level={2} />
		</div>

		<div
			class="relative max-md:mt-0 mt-8"
			aria-label="Projects"
			data-testid="projects-section">
			<div
				class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"
				data-testid="projects-list">
				{
					displayedProjects.map(project => (
						<ProjectCard
							name={project.data.name ?? extractNameFromFilename(project.id)}
							imageURL={project.data.imageURL}
							technologies={project.data.technologies}
							shortDescription={project.data.shortDescription}
							slug={project.slug}
							companyLogoURL={project.companyLogoURL}
							linkedCompany={project.data.linkedCompany}
							projects={projects}
							dateStart={project.data.dateStart}
							dateEnd={project.data.dateEnd}
						/>
					))
				}
			</div>
			{
				sortedProjects.length > maxProjectsDisplay && (
					<div class="flex justify-center mt-12">
						<a
							href="/projects"
							class="bg-theme-400 hover:bg-theme-500 text-black font-bold px-8 py-3 rounded-full transition-all duration-300 text-lg"
							data-umami-event="See more projects">
							See more projects
						</a>
					</div>
				)
			}
		</div>
	</div>
</section>
