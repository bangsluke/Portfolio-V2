---
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';
import Heading from '../ui/Heading.astro';
import ProjectCard from './ProjectCard.astro';

// Get all projects, companies, and clients from the local content folders
const projects = await getCollection('projects');
const companies = await getCollection('companies');
const clients = await getCollection('clients');

// Sort projects by portfolioOrder + dateStart, then alphabetically
const sortedProjects = projects.sort((a, b) => {
	// Create sort keys: portfolioOrder + "-" + dateStart
	const getSortKey = (project: any) => {
		const portfolioOrder = project.data.portfolioOrder || 999; // Default to high number if not set
		const dateStart = project.data.dateStart || new Date(0);
		const dateString =
			dateStart instanceof Date ? dateStart.toISOString() : String(dateStart);
		return `${portfolioOrder}-${dateString}`;
	};

	const keyA = getSortKey(a);
	const keyB = getSortKey(b);

	// Sort by the combined key
	const sortResult = keyA.localeCompare(keyB);

	// If keys are equal, fallback to alphabetical sorting by slug
	if (sortResult === 0) {
		return a.slug.localeCompare(b.slug);
	}

	return sortResult;
});

// Process projects to include company/client logos
const processedProjects = sortedProjects.map(project => {
	let companyLogoURL = null;

	// If project has linkedCompany, find the company or client and get its logoURL
	if (project.data.linkedCompany && project.data.linkedCompany.length > 0) {
		// Get the first linked company and strip Obsidian link format
		const linkedCompanyRaw = project.data.linkedCompany[0];
		const linkedCompanyName = linkedCompanyRaw.replace(/\[\[|\]\]/g, ''); // Remove [[ and ]]

		// First try to find in companies collection
		const company = companies.find(company => {
			const companyName = company.id.replace('.md', ''); // Remove .md extension
			return companyName === linkedCompanyName;
		});

		if (company && company.data.logoURL) {
			companyLogoURL = company.data.logoURL;
		} else {
			// If not found in companies, try clients collection
			const client = clients.find(client => {
				const clientName = client.id.replace('.md', ''); // Remove .md extension
				return clientName === linkedCompanyName;
			});

			if (client && client.data.logoURL) {
				companyLogoURL = client.data.logoURL;
			}
		}
	}

	return {
		...project,
		companyLogoURL,
	};
});

// Show only first 6 projects
const displayedProjects = processedProjects.slice(0, 6);
---

<section class="py-8 px-8 max-md:py-4 mb-4 scroll-m-16" id="projects">
	<div class="flex flex-col pt-8 max-w-7xl mx-auto">
		<div class="flex gap-4 items-center justify-center">
			<Icon class="text-3xl dark:text-white text-blacktext" name="code" />
			<Heading text="" textGradient="Projects " level={2} />
		</div>

		<div class="relative max-md:mt-0 mt-8" aria-label="Projects">
			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
				{
					displayedProjects.map(project => (
						<ProjectCard
							name={
								project.data.name ??
								project.slug
									.replace(/-/g, ' ')
									.replace(/\b\w/g, l => l.toUpperCase())
							}
							imageURL={project.data.imageURL}
							technologies={project.data.technologies}
							shortDescription={project.data.shortDescription}
							slug={project.slug}
							companyLogoURL={project.companyLogoURL}
							linkedCompany={project.data.linkedCompany}
						/>
					))
				}
			</div>
			{
				sortedProjects.length > 6 && (
					<div class="flex justify-center mt-12">
						<a
							href="/portfolio/projects"
							class="bg-mint-400 hover:bg-mint-500 text-black font-bold px-8 py-3 rounded-full transition-all duration-300 text-lg">
							See more projects
						</a>
					</div>
				)
			}
		</div>
	</div>
</section>
